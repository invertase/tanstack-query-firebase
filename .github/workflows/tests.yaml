name: Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.4

      - name: Install dependencies
        run: pnpm install

      - name: Run format check
        run: pnpm format

      # Determine which packages have changed
      - name: Determine changed packages
        id: quality-changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            react:
              - 'packages/react/**'
            angular:
              - 'packages/angular/**'

      - name: Check for changesets
        run: |
          # Check if any packages have changed
          packages_changed=$([[ "${{ steps.quality-changes.outputs.react }}" == "true" ]] || [[ "${{ steps.quality-changes.outputs.angular }}" == "true" ]])
          if [[ "$packages_changed" == "true" ]]; then
            # Check if .changeset directory exists and contains .md files
            if [ ! -d .changeset ] || [ -z "$(find .changeset -name '*.md' -type f 2>/dev/null | head -1)" ]; then
              echo "❌ Changes detected in packages but no changesets found."
              echo ""
              echo "Please create a changeset with 'pnpm changeset' for changes that should be released."
              echo "If these changes don't need a release, please add a comment explaining why."
              echo ""
              echo "Changed packages:"
              if [[ "${{ steps.quality-changes.outputs.react }}" == "true" ]]; then
                echo "- React package"
              fi
              if [[ "${{ steps.quality-changes.outputs.angular }}" == "true" ]]; then
                echo "- Angular package"
              fi
              exit 1
            else
              echo "✅ Found changesets for package changes"
              echo ""
              echo "Changesets:"
              find .changeset -name '*.md' -type f
            fi
          else
            echo "ℹ️  No package changes detected, skipping changeset check"
          fi

  test:
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.4

      - name: Install dependencies
        run: pnpm install

      - name: Install Firebase CLI
        uses: nick-invision/retry@v3
        with:
          timeout_minutes: 10
          retry_wait_seconds: 60
          max_attempts: 3
          command: npm i -g firebase-tools@14

      # Determine which packages have changed
      - name: Determine changed packages
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            react:
              - 'packages/react/**'
            angular:
              - 'packages/angular/**'

      # Run tests with emulator for changed packages
      - name: Run tests with emulator
        run: pnpm test:emulator
